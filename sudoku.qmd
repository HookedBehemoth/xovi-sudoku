AFFECT /xofm/libs/toolbar/impl/Toolbar.qml
    IMPORT common 1.0
    IMPORT net.sudoku 1.0
    TRAVERSE FocusScope > Item#toolbar > GridLayout
        LOCATE AFTER Repeater[.model=`toolbarProvider.editingTools`]
        INSERT {

ToolbarTool {
    id: puzzleOptions
    toolbar: root
    type: ToolbarTool.Type.FoldoutButton

    iconSource: "qrc:/ark/icons/grid"
    enabled: true
    visible: root.expanded
    onPressed: root._select(puzzleOptions)

    function drawPuzzle(difficulty) {
        const puzzle = PuzzleManager.getSudoku(difficulty);
        if (puzzle === undefined ) {
            return;
        }

        sceneController.setLayerName(sceneController.currentLayer, "Sudoku")

        for (var idx = 0; idx < 81; ++idx) {
            var numLine = PuzzleManager.getSudokuNumber(puzzle, idx % 9, idx / 9, true);
            if (numLine === undefined) {
                continue;
            }

            // draw hint
            sceneController.addDrawingLine(numLine);
            sceneView.tileManager.renderLineToTiles(numLine);
        }

        // draw surrouding grid
        const sudokuGrid = PuzzleManager.createGrid();
        sceneController.addDrawingLine(sudokuGrid);
        sceneView.tileManager.renderLineToTiles(sudokuGrid);

        sceneView.tileManager.reload();

        sceneController.addLayer();
        root._select(puzzleOptions);
    }

    // draws a line above the top of the page, selects and dumps that selection
    // to obtain the vtable.
    property var hasSceneLineItemVtable: false;
    function ensureVtablePtr() {
        if (hasSceneLineItemVtable) {
            return;
        }

        sceneController.clearSelectedItems();
        PuzzleManager.sleepMs(10);
        sceneController.addDrawingLine(
            PuzzleManager.createLine(Qt.point(-5, -10), Qt.point(5, -10)));
        PuzzleManager.sleepMs(10);
        sceneController.selectWithLine(
            PuzzleManager.createCircle(Qt.point(0, -10), 10))
        PuzzleManager.sleepMs(10);
        hasSceneLineItemVtable = PuzzleManager.setupVtablePtr(
            sceneController.cloneSelectedItems(sceneController.currentLayer, sceneView.defaultScale));
        sceneController.deleteSelectedItems(sceneController.currentLayer);
        sceneController.clearSelectedItems();
    }

    foldoutContent: ColumnLayout {
        spacing: 0

        ListModel {
            id: difficulties
            ListElement {
                difficulty: 0
                description: "Easy"
            }
            ListElement {
                difficulty: 1
                description: "Medium"
            }
            ListElement {
                difficulty: 2
                description: "Hard"
            }
            ListElement {
                difficulty: 3
                description: "Expert"
            }
        }

        Repeater {
            model: difficulties

            ArkControls.FoldoutItem {
                required property string description
                required property int difficulty

                label: description
                iconSource: "qrc:/ark/icons/grid"
                antialiasing: root.antialiasing
                focusPolicy: Qt.NoFocus
                Layout.fillWidth: true
                onClicked: puzzleOptions.drawPuzzle(difficulty)
            }
        }

        ArkControls.FoldoutItem {
            label: "Dump Scene"
            iconSource: "qrc:/ark/icons/grid"
            antialiasing: root.antialiasing
            focusPolicy: Qt.NoFocus
            Layout.fillWidth: true
            onClicked: sceneController.dumpScene()
        }

        ArkControls.FoldoutItem {
            label: "Log Clipboard"
            iconSource: "qrc:/ark/icons/grid"
            antialiasing: root.antialiasing
            focusPolicy: Qt.NoFocus
            Layout.fillWidth: true
            onClicked: PuzzleManager.logSceneItems(Clipboard.items)
        }

        ArkControls.FoldoutItem {
            label: "Copy Crosshair"
            iconSource: "qrc:/ark/icons/grid"
            antialiasing: root.antialiasing
            focusPolicy: Qt.NoFocus
            Layout.fillWidth: true
            onClicked: {
                puzzleOptions.ensureVtablePtr();
                root._select(puzzleOptions);
                root.selectSelection();
                Clipboard.items = PuzzleManager.copyCrosshair();
            }
        }

        ArkControls.FoldoutItem {
            label: "Copy Stars"
            iconSource: "qrc:/ark/icons/grid"
            antialiasing: root.antialiasing
            focusPolicy: Qt.NoFocus
            Layout.fillWidth: true
            onClicked: {
                puzzleOptions.ensureVtablePtr();
                root._select(puzzleOptions);
                root.selectSelection();
                Clipboard.items = PuzzleManager.copyStars(20, 800.0);
            }
        }
    }
}

        }
    END TRAVERSE
END AFFECT
